package com.mycompany.app;

import java.awt.geom.Point2D;
import java.io.IOException;
import java.net.UnknownHostException;

import org.msgpack.type.Value;

import com.mycompany.app.AirSimMessages.YawMode;

import gametheory.ControllerHandler;
import gametheory.PerfectPursuer;
import gametheory.Player;
import manualInput.XboxController;
import visualiser.GlobalField;
import visualiser.GlobalFieldWindow;

/**
 * Hello world!
 *
 */
public class App 
{
    public static void main( String[] args ) throws InterruptedException, IOException
    {
		if (args.length < 2) {
			System.out.println("Please specify speed and capture/turn ratios");
			System.exit(1);
		}
		
		double gamma = Double.parseDouble(args[0]);
		double beta = Double.parseDouble(args[1]);
		
		double baseV = 2;
		double baseR = 0.1;
		
		//Player p = new Player(new Point2D.Double(0.5, 0), 0, 1, 1);
		
		GlobalFieldWindow vis = new GlobalFieldWindow(1200, beta*baseR);
		
		ControllerHandler xbox = new ControllerHandler();
		
		while (true) {
			
			Player e = new Player(new Point2D.Double(0.5, 0.4), -Math.PI/2, gamma*baseV);
			
			PerfectPursuer p = new PerfectPursuer(new Point2D.Double(0.25, 0), 0, baseV, 0.8*baseR, beta*baseR, e);
			PerfectPursuer p2 = new PerfectPursuer(new Point2D.Double(0.75, 0.75), 0, 1.2*baseV, baseR, beta*baseR, e);
			
			while (!p.targetCaught() && !p2.targetCaught()) {//&& (t < 100000)) {
				
				//e.steer(Math.sin(t/(16*Math.PI)));
				if (xbox.gamepadSet()) {
					e.steer(xbox.pollLeftJoyStick());
				} else {
					e.steerInBox();
				}
				
				e.move();
				//System.out.println("Speed is perceived as " + p.estimateVelocity());
				p.stalk();
				p2.stalk();
				
				//p.linearPredictStalk();
				
				vis.setPursuerState(p.getPos(), p.getTheta());
				//vis.setPursuerState(p2.getPos(), p2.getTheta(), "p2");
				vis.setEvaderState(e.getPos(), e.getTheta());
				vis.addPursuerSegment(p.getLastMovement(), "p");
				vis.addPursuerSegment(p2.getLastMovement(), "p2");
				vis.addEvaderSegment(e.getLastMovement());
				
				vis.repaint();
				
				Thread.sleep(10);
			}
			
			
			vis.setPursuerPath(p.getPath(), "p");
			vis.setPursuerPath(p2.getPath(), "p2");
			vis.setEvaderPath(e.getPath());
			
			vis.repaint();
			
			System.out.println("Press any key to play again:");
			vis.waitKey();
			vis.clearAll();
		}

	}
    
    public static void oldMain() throws InterruptedException {
    	GlobalField g = new GlobalField(50, 0.5);
    	XboxController con = new XboxController();
//    	double t1 = 0;
//    	double angle1;
//    	while (t1 < 15) {
//			angle1 = con.pollLeftJoyStick();
//			System.out.println(angle1);
//			t1 += 0.1;
//			Thread.sleep(100);
//    	}
    	
        DronePlayer pursuer = new DronePlayer("", 41451, 1);
		System.out.println( "Hello World!" );
		
		pursuer.confirmConnection();
		pursuer.enableApiControl(true);
		boolean respP = pursuer.isApiControlEnabled();
		System.out.println(respP);
		
		
		
		DronePlayer evader = new DronePlayer("", 41452, 1);
		evader.confirmConnection();
		evader.enableApiControl(true);
		boolean respE = evader.isApiControlEnabled();
		System.out.println(respE);
		
		evader.armDisarm(true);
		evader.takeoff(20);
		
		evader.moveToZ(-7, 1);
		evader.moveByVelocityZ(new Vector3r(0, 1, 0), new Vector3r(0,  0, -7), 15);
				
	
		
		try {
			
			
			pursuer.armDisarm(true);
			pursuer.takeoff(20);
			
			double t = 0;
			
			double angle;
			while (t < 300) {
				angle = con.pollLeftJoyStick();
				//System.out.println(angle);
				Vector3r eVel = new Vector3r((float) Math.sin(angle), (float) Math.cos(angle), 0f);
				//System.out.println("eVel = "+eVel.toString());
				double poseAngle = -angle + Math.PI/2;
				float pose = (float) Math.toDegrees(Math.atan2(Math.sin(poseAngle), Math.cos(poseAngle)));
				System.out.println(pose);
				pursuer.rotateToYaw(pose);
				pursuer.moveByVelocityZ(eVel, new Vector3r(0,  0, -7), 20, DrivetrainType.ForwardOnly, new YawMode(true, 0f));
//				
//				Vector3r ePos = evader.getPosition();
//				System.out.println(ePos);
				
				//evader.moveByVelocityZ(new Vector3r(0, 1, 0), new Vector3r(0,  0, -7), 20);
				
				Thread.sleep(100);
				t += 0.1;
			}
			
		} catch (Exception e) {
			System.out.println(e.getStackTrace());
		}
		

    }
}
